# SNIPER v2 — Feature Evolution Plan

> **Goal:** Transform SNIPER from a greenfield-only, single-pass lifecycle tool into a world-class framework for continuous agent-team-based development across the full product lifecycle.

---

## Problem Statement

SNIPER today assumes every project starts from zero and runs through the lifecycle exactly once. Specifically:

1. **Linear phase progression only** — commands warn you if you re-run a phase, treating it as regression rather than iteration.
2. **Artifacts are created, never updated** — discover/plan/solve overwrite their outputs. No diff-based updates to PRD, architecture, or stories.
3. **Story creation is all-or-nothing** — `/sniper-solve` creates all epics/stories from scratch. No "add stories for a new feature" mode.
4. **No artifact versioning** — no change logs, version numbers, or "supersedes" fields in any template.
5. **No post-sprint lifecycle** — no debugging, maintenance, incident response, or production support workflows.
6. **No codebase-aware bootstrapping** — can't ingest an existing project's architecture, patterns, and conventions to seed artifacts.

This plan addresses all of these gaps and adds capabilities that make SNIPER the definitive framework for agent-team development.

---

## Feature Numbering & Artifact Convention

Every feature gets a unique **SNPR-XXXX** identifier (zero-padded, incrementing). Each feature produces its own PRD and implementation plan under a numbered directory:

```
plans/
├── sniper-v2-features.md          # This roadmap document
└── features/
    ├── SNPR-0001/
    │   ├── prd.md                  # Product Requirements Document
    │   ├── plan.md                 # Implementation Plan
    │   └── stories/               # Stories generated by /sniper-solve
    ├── SNPR-0002/
    │   ├── prd.md
    │   ├── plan.md
    │   └── stories/
    └── ...
```

### Feature Registry

| ID | Feature | Status |
|----|---------|--------|
| SNPR-0001 | Artifact Versioning & Amendment | Complete |
| SNPR-0002 | Flexible Phase Navigation | Complete |
| SNPR-0003 | Codebase Ingestion (`/sniper-ingest`) | Complete |
| SNPR-0004 | Incremental Feature Lifecycle (`/sniper-feature`) | Complete |
| SNPR-0005 | Production Debugging (`/sniper-debug`) | Complete |
| SNPR-0006 | Audit: Refactoring (`/sniper-audit --target refactor`) | Complete |
| SNPR-0007 | Audit: Review & QA (`/sniper-audit --target review`) | Complete |
| SNPR-0008 | Audit: Test & Coverage (`/sniper-audit --target tests`) | Complete |
| SNPR-0009 | Audit: Security (`/sniper-audit --target security`) | Complete |
| SNPR-0010 | Audit: Performance (`/sniper-audit --target performance`) | Complete |
| SNPR-0011 | Improved Domain Packs | Complete |
| SNPR-0012 | Agent Memory & Learning | Complete |
| SNPR-0013 | Multi-Project Orchestration | Complete |

Statuses: `Planned` → `PRD Written` → `Plan Written` → `In Progress` → `Complete`

### Counter tracking

The next available ID is tracked in `.sniper/config.yaml`:

```yaml
features:
  next_id: 14  # next SNPR number to assign
```

When a new feature is proposed (via `/sniper-feature` or manually), it gets the next ID and the counter increments.

---

## Feature Areas

### SNPR-0001 — Artifact Versioning & Amendment

> **Phase A — Foundation**

See `plans/features/SNPR-0001/prd.md` (to be written).

Makes all artifacts living documents with version headers, change logs, managed sections, and diff-based amendment mode for all phase commands.

---

### SNPR-0002 — Flexible Phase Navigation

> **Phase A — Foundation**

See `plans/features/SNPR-0002/prd.md` (to be written).

Replaces the linear state machine with a directed graph. Phase re-entry becomes normal. Config tracks a phase log instead of a single `current_phase`.

---

### SNPR-0003 — Codebase Ingestion (`/sniper-ingest`)

> **Phase A — Foundation**

See `plans/features/SNPR-0003/prd.md` (to be written).

3-agent team reverse-engineers architecture, conventions, and project structure from an existing codebase to bootstrap SNIPER artifacts.

---

### SNPR-0004 — Incremental Feature Lifecycle (`/sniper-feature`)

> **Phase A — Foundation** — the flagship v2 capability

See `plans/features/SNPR-0004/prd.md` (to be written).

Lightweight lifecycle for adding a single feature to an existing project. Runs mini-discovery (feature brief), mini-planning (feature spec + architecture delta), scoped story generation, and sprint — all under `docs/features/{slug}/`. On completion, the architecture delta merges back into the main architecture doc.

---

### SNPR-0005 — Production Debugging (`/sniper-debug`)

> **Phase B — Production Lifecycle**

See `plans/features/SNPR-0005/prd.md` (to be written).

Agent-team-based debugging: triage lead, log analyst, code investigator, fix engineer, and regression guard. Produces structured bug reports, investigation logs, and post-mortems under `docs/bugs/{slug}/`.

---

### SNPR-0006 — Audit: Refactoring (`/sniper-audit --target refactor`)

> **Phase B — Production Lifecycle**

See `plans/features/SNPR-0006/prd.md` (to be written).

Structured agent-team refactoring for large-scale code changes (e.g., framework migrations). Impact analyst, migration architect, migration engineers, and compatibility tester. Produces scoped artifacts under `docs/refactors/{slug}/`. Distinct from `/sniper-feature` because refactoring changes *how* code works without changing *what* it does.

---

### SNPR-0007 — Audit: Review & QA (`/sniper-audit --target review`)

> **Phase B — Production Lifecycle**

See `plans/features/SNPR-0007/prd.md` (to be written).

Dedicated review teams for PR review (`--pr 42`) and release readiness (`--release v2.5.0`). PR team: code reviewer, security reviewer, test reviewer. Release team: release manager, breaking change analyst, release notes writer.

---

### SNPR-0008 — Audit: Test & Coverage (`/sniper-audit --target tests`)

> **Phase C — Quality & Depth**

See `plans/features/SNPR-0008/prd.md` (to be written).

Agent team for improving test quality. Targets: coverage gaps, flaky tests, missing integration tests. Coverage analyst, test architects, parallel test writers, and flake hunter.

---

### SNPR-0009 — Audit: Security (`/sniper-audit --target security`)

> **Phase C — Quality & Depth**

See `plans/features/SNPR-0009/prd.md` (to be written).

Proactive security review: threat modeler, vulnerability scanner, remediation engineer, audit reporter. Produces `docs/security/audit-{date}.md`.

---

### SNPR-0010 — Audit: Performance (`/sniper-audit --target performance`)

> **Phase C — Quality & Depth**

See `plans/features/SNPR-0010/prd.md` (to be written).

Agent team for performance investigation: profiler, optimization engineer, benchmark writer. Targets specific performance regressions or general optimization.

---

### SNPR-0011 — Improved Domain Packs

> **Phase C — Quality & Depth**

See `plans/features/SNPR-0011/prd.md` (to be written).

Extend packs beyond knowledge files to include domain-specific personas, checklists, story templates, workflows, and composable pack stacking (e.g., SaaS + Healthcare = multi-tenant HIPAA-compliant checklists).

---

### SNPR-0012 — Agent Memory & Learning

> **Phase D — Advanced**

See `plans/features/SNPR-0012/prd.md`.

Three-tier memory system operating at project, workspace, and organization levels. Structured YAML memory stores (conventions, anti-patterns, decisions, estimation calibration) injected into spawn prompts as a contextual layer. Automatic sprint retrospectives extract learnings and codify high-confidence findings. Review gates enforce convention compliance and anti-pattern detection. Memory export/import enables cross-project knowledge transfer. Integrates with SNPR-0013 for workspace-level shared memory across repositories.

---

### SNPR-0013 — Multi-Project Orchestration

> **Phase D — Advanced**

See `plans/features/SNPR-0013/prd.md`.

Workspace abstraction coordinating agent teams across multiple repositories. Contract-first execution model: during planning, generate shared interface contracts (API schemas, types, events), then each repo sprints independently against those contracts. Wave-based sprint orchestration follows the dependency graph (library → backend → frontend). Contract validation between waves catches mismatches before downstream repos begin. Includes workspace-level feature planning (`WKSP-XXXX`), auto-detection of repo dependencies, and integration with SNPR-0012 for cross-repo memory and convention enforcement.

---

## Implementation Priority

### Phase A — Foundation (must-have for v2)

| ID | Feature | Effort | Impact |
|----|---------|--------|--------|
| SNPR-0001 | Artifact Versioning & Amendment | Medium | Unblocks everything else |
| SNPR-0002 | Flexible Phase Navigation | Medium | Removes greenfield-only constraint |
| SNPR-0003 | Codebase Ingestion (`/sniper-ingest`) | Medium | Enables existing project adoption |
| SNPR-0004 | Incremental Feature Lifecycle (`/sniper-feature`) | Large | The flagship v2 capability |

### Phase B — Production Lifecycle

| ID | Feature | Effort | Impact |
|----|---------|--------|--------|
| SNPR-0005 | Production Debugging (`/sniper-debug`) | Medium | High-value for production teams |
| SNPR-0006 | Audit: Refactoring | Medium | Common need for maturing projects |
| SNPR-0007 | Audit: Review & QA | Small | Fills a clear gap |

### Phase C — Quality & Depth

| ID | Feature | Effort | Impact |
|----|---------|--------|--------|
| SNPR-0008 | Audit: Test & Coverage | Medium | Drives quality |
| SNPR-0009 | Audit: Security | Medium | Enterprise value |
| SNPR-0010 | Audit: Performance | Small | Targeted use case |
| SNPR-0011 | Improved Domain Packs | Medium | Ecosystem value |

### Phase D — Advanced

| ID | Feature | Effort | Impact |
|----|---------|--------|--------|
| SNPR-0012 | Agent Memory & Learning | Large | Long-term agent quality |
| SNPR-0013 | Multi-Project Orchestration | Large | Enterprise-scale adoption |

---

## Architecture Implications

### New framework files needed

```
packages/core/framework/
├── commands/
│   ├── sniper-feature.md      # NEW
│   ├── sniper-ingest.md       # NEW
│   ├── sniper-debug.md        # NEW
│   └── sniper-audit.md        # NEW — consolidated (refactor, tests, security, performance, review)
├── teams/
│   ├── feature-scope.yaml     # NEW - mini-discovery team
│   ├── feature-plan.yaml      # NEW - mini-planning team
│   ├── ingest.yaml            # NEW
│   ├── debug.yaml             # NEW
│   ├── refactor.yaml          # NEW
│   ├── review-pr.yaml         # NEW
│   ├── review-release.yaml    # NEW
│   ├── test.yaml              # NEW
│   ├── security.yaml          # NEW
│   └── perf.yaml              # NEW
├── workflows/
│   ├── feature-lifecycle.md   # NEW
│   ├── debug-workflow.md      # NEW
│   └── maintenance.md         # NEW - umbrella for refactor/test/perf/audit
├── templates/
│   ├── feature-brief.md       # NEW
│   ├── feature-spec.md        # NEW
│   ├── arch-delta.md          # NEW
│   ├── bug-report.md          # NEW
│   ├── investigation.md       # NEW
│   ├── postmortem.md          # NEW
│   ├── refactor-scope.md      # NEW
│   ├── migration-plan.md      # NEW
│   ├── conventions.md         # NEW
│   ├── pr-review.md           # NEW
│   ├── release-readiness.md   # NEW
│   ├── coverage-report.md     # NEW
│   ├── flaky-report.md        # NEW
│   ├── threat-model.md        # NEW
│   ├── vulnerability-report.md # NEW
│   ├── performance-profile.md # NEW
│   └── optimization-plan.md   # NEW
├── checklists/
│   ├── feature-review.md      # NEW
│   ├── debug-review.md        # NEW
│   ├── refactor-review.md     # NEW
│   ├── test-review.md         # NEW
│   ├── security-review.md     # NEW
│   └── perf-review.md         # NEW
├── personas/process/
│   ├── code-archaeologist.md      # NEW
│   ├── architecture-cartographer.md # NEW
│   ├── convention-miner.md        # NEW
│   ├── triage-lead.md             # NEW
│   ├── log-analyst.md             # NEW
│   ├── code-investigator.md       # NEW
│   ├── impact-analyst.md          # NEW
│   ├── migration-architect.md     # NEW
│   ├── code-reviewer.md           # NEW
│   ├── release-manager.md         # NEW
│   ├── coverage-analyst.md        # NEW
│   ├── flake-hunter.md            # NEW
│   ├── threat-modeler.md          # NEW
│   ├── vuln-scanner.md            # NEW
│   └── perf-profiler.md           # NEW
└── config.template.yaml           # MODIFIED - expanded state model
```

### Config schema evolution

The `config.yaml` schema needs to evolve from a linear state machine to a richer model:

```yaml
# v2 config additions
state:
  lifecycle: greenfield | existing | maintenance
  phase_log: [...]           # replaces current_phase + phase_history
  current_sprint: 0
  features: [...]            # feature lifecycle tracking
  bugs: [...]                # debug tracking
  refactors: [...]           # refactor tracking
  artifacts:
    brief:
      status: draft | approved
      version: 1
      path: docs/brief.md
    # ... same pattern for all artifacts

conventions:
  file: docs/conventions.md
  enforced: true             # whether review gates check conventions

memory:
  file: .sniper/memory.md
  anti_patterns: .sniper/anti-patterns.yaml
```

### CLI changes

- `sniper init` gains `--existing` flag that runs ingestion after scaffolding
- `sniper status` shows features, bugs, and refactors in addition to phase state
- New CLI commands: `sniper feature list`, `sniper bug list` for quick status views

---

## Success Criteria

SNIPER v2 is successful when:

1. A developer can run `/sniper-ingest` on an existing 50k+ line codebase and get useful architecture + conventions docs in one session.
2. A developer can run `/sniper-feature "add webhooks"` and get from idea to merged PR with proper planning artifacts, without touching the existing PRD or architecture doc (they get feature-scoped artifacts instead).
3. A developer can run `/sniper-debug "checkout 500 errors"` and get from bug report to fix PR with investigation artifacts, without manually coordinating agents.
4. All existing greenfield workflows continue to work unchanged.
5. Re-running any phase command on a project with existing artifacts produces an amendment, not an overwrite.
